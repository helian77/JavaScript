<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì•½ ìœ„ì¹˜ ì°¾ê¸° + ìˆ˜ì • ìš”ì²­</title>
<style>
body {
    font-family: Arial, sans-serif;
    margin: 0; padding: 0;
    display: flex;
    flex-direction: row;
    height: 100vh;
}
#mainContent {
    flex: 2;
    padding: 20px;
    overflow-y: auto;
}
#requestSidebar {
    flex: 1;
    border-left: 2px solid #ccc;
    padding: 20px;
    max-width: 400px;
    overflow-y: auto;
    background: #fdf7e3;
}
input, textarea, button {
    font-family: inherit;
}
table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
}
th, td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: center;
    word-wrap: break-word;
}
th { background-color: #f4f4f4; }
.drug-img { width: 80px; height: auto; cursor:pointer; }
.modal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); display:flex; justify-content:center; align-items:center; }
.modal-content { max-width:90%; max-height:90%; }
.modal-img { width:auto; height:auto; max-width:100%; max-height:100%; border-radius:10px; }
#requestInput { width:100%; height:60px; resize:none; margin-bottom:6px; }
.delete-btn { background:#ff6b6b; border:none; padding:4px 8px; color:#fff; cursor:pointer; border-radius:4px; }
.delete-btn:hover { background:#e03434; }
#requestList li { display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; padding:4px 6px; border:1px solid #ccc; background:#fff; }
#requestList { list-style:none; padding:0; }
</style>
</head>
<body>

<div id="mainContent">
    <h1>ì•½ ìœ„ì¹˜ ì°¾ê¸°</h1>
    <input type="text" id="searchBox" placeholder="ì•½ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" onkeyup="searchDrug()">
    <table id="drugTable">
        <thead>
            <tr>
                <th>ì•½í’ˆ ì‚¬ì§„</th>
                <th>ì•½í’ˆëª…</th>
                <th>ìœ„ì¹˜</th>
                <th>ìœ„ì¹˜ ì‚¬ì§„</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<div id="requestSidebar">
    <h2>ğŸ“ ìˆ˜ì • ìš”ì²­ ëª©ë¡</h2>
    <textarea id="requestInput" maxlength="200" placeholder="200ì ì´ë‚´ë¡œ ìˆ˜ì • ìš”ì²­ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
    <div style="margin-bottom:10px;">
        <button id="addSharedBtn">ê³µìœ  ì €ì¥</button>
        <button id="addLocalBtn">ë¡œì»¬ ì €ì¥</button>
    </div>
    <ul id="requestList"></ul>
</div>

<script>
// ==================== ì•½í’ˆ ë°ì´í„° ====================
const gistUrl = "https://gist.githubusercontent.com/helian77/636699d654546e461d13702adbf34eff/raw/drug_list.txt";
const imageCache = {}; let currentModal = null;

async function fetchDrugData() {
    try {
        const resp = await fetch(gistUrl);
        const data = await resp.text();
        return parseCsv(data);
    } catch { return []; }
}
function parseCsv(csvData) {
    const lines = csvData.trim().split("\n");
    const headers = lines[0].split("\t");
    const nameIndex = headers.indexOf("name");
    const locationIndex = headers.indexOf("location");
    const imageIndex = headers.indexOf("image");
    return lines.slice(1).map(line=>{
        const parts = line.split("\t");
        const locationParts = parts[locationIndex].trim().split("/").map(l=>l.trim().replace(/-.+$/,"")).filter(l=>!l.includes("ì¹´ì„¸íŠ¸"));
        const locationImages = [...new Set(locationParts.map(loc=>`location/thumbnail/${loc}.png`))];
        return { name: parts[nameIndex].trim(), location: parts[locationIndex].trim(), imageUrl: parts[imageIndex].trim(), locationImages };
    });
}

async function displayDrugList() {
    const tbody = document.querySelector("#drugTable tbody");
    tbody.innerHTML="<tr><td colspan='4'>ë¡œë”© ì¤‘...</td></tr>";
    const drugs = await fetchDrugData();
    if(drugs.length===0){ tbody.innerHTML="<tr><td colspan='4'>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</td></tr>"; return;}
    tbody.innerHTML="";
    drugs.forEach(d=>{
        const imgs = d.locationImages.map(img=>`<img src="${img}" class="drug-img small" onerror="this.onerror=null; this.src='location/default.png';">`).join(" ");
        const row = document.createElement("tr");
        row.innerHTML=`<td><img src="${d.imageUrl}" class="drug-img" onerror="this.onerror=null; this.src='default.png';"></td>
            <td class="drug-name">${d.name}</td>
            <td>${d.location}</td>
            <td>${imgs}</td>`;
        tbody.appendChild(row);
    });
    document.querySelectorAll(".drug-img").forEach(img=>{
        img.addEventListener("click",function(){
            let src=this.src;
            if(src.includes("/thumbnail/")) src=src.replace("/thumbnail/","/");
            showImagePopup(src);
        });
    });
}
function showImagePopup(src){
    if(currentModal) currentModal.remove();
    let imgEl = imageCache[src] || (imageCache[src]=document.createElement("img"));
    imgEl.src=src; imgEl.className="modal-img";
    const modal=document.createElement("div"); modal.className="modal";
    const modalContent=document.createElement("div"); modalContent.className="modal-content";
    modalContent.appendChild(imgEl); modal.appendChild(modalContent);
    modal.addEventListener("click",()=>modal.remove());
    document.body.appendChild(modal); currentModal=modal;
}
function searchDrug(){
    const q=document.getElementById("searchBox").value.trim().toLowerCase();
    document.querySelectorAll("#drugTable tbody tr").forEach(r=>{
        const n=r.querySelector(".drug-name").textContent.toLowerCase();
        r.style.display=n.includes(q)?"":"none";
    });
}
window.onload=displayDrugList;

// ==================== ìˆ˜ì • ìš”ì²­ ====================
const gistRawUrl="https://gist.githubusercontent.com/helian77/2ba3078e640845962ad251c3f40e696a/raw/e31e019b67f5084cc63ee40c9f31f05023e3da2d/request_list.txt";
const gistId="2ba3078e640845962ad251c3f40e696a";
const gistFileName="request_list.txt";
const githubToken="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"; // í•˜ë“œì½”ë”©

function formatNow(){const d=new Date(),p=n=>String(n).padStart(2,"0");return`${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`;}
async function fetchRemoteRequests(){try{const r=await fetch(gistRawUrl,{cache:"no-store"});return (await r.text()).trim();}catch{return"";}}
function escapeHtml(s){return s.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]);}

async function patchGist(content){
    const url=`https://api.github.com/gists/${gistId}`;
    const body={files:{}};
    body.files[gistFileName]={content};
    const r=await fetch(url,{method:"PATCH",headers:{"Authorization":"token "+githubToken,"Accept":"application/vnd.github.v3+json","Content-Type":"application/json"},body:JSON.stringify(body)});
    if(!r.ok)throw new Error(await r.text());
    return await r.json();
}

async function loadRequests(){
    const ul=document.getElementById("requestList"); ul.innerHTML="<li>ë¡œë”© ì¤‘...</li>";
    const remote=(await fetchRemoteRequests()).split("\n").filter(l=>l.trim());
    if(remote.length===0){ ul.innerHTML="<li>ìš”ì²­ ì—†ìŒ</li>"; return; }
    ul.innerHTML="";
    remote.forEach((line,idx)=>{
        const li=document.createElement("li");
        li.innerHTML=`<span style="flex:1;text-align:left;">${escapeHtml(line)}</span>
        <button class="delete-btn" data-idx="${idx}">ì™„ë£Œ</button>`;
        ul.appendChild(li);
    });
    document.querySelectorAll(".delete-btn").forEach(b=>b.onclick=async e=>{
        const i=Number(e.currentTarget.dataset.idx);
        if(!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?"))return;
        const arr=remote.slice(); arr.splice(i,1);
        try{await patchGist(arr.join("\n")); loadRequests();}catch(err){alert("ì‚­ì œ ì‹¤íŒ¨:"+err.message);}
    });
}

document.addEventListener("DOMContentLoaded",()=>{
    loadRequests();
    document.getElementById("addSharedBtn").onclick=async()=>{
        const txt=document.getElementById("requestInput").value.trim();
        if(!txt){alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”");return;}
        if(txt.length>200){alert("200ì ì´í•˜ë¡œ ì…ë ¥í•˜ì„¸ìš”");return;}
        const newLine=formatNow()+" | "+txt;
        const old=(await fetchRemoteRequests());
        try{await patchGist(newLine+(old? "\n"+old:"")); document.getElementById("requestInput").value=""; loadRequests(); alert("Gistì— ì¶”ê°€ë¨");}
        catch(err){alert("ì¶”ê°€ ì‹¤íŒ¨:"+err.message);}
    };
});
</script>
</body>
</html>
