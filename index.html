<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì•½ ìœ„ì¹˜ ì°¾ê¸° + ìˆ˜ì • ìš”ì²­</title>
<style>
body { font-family: Arial; margin:0; padding:0; display:flex; height:100vh; }
#mainContent { flex:2; padding:20px; overflow-y:auto; }
#requestSidebar { flex:1; max-width:400px; padding:20px; border-left:2px solid #ccc; background:#fdf7e3; overflow-y:auto; }
input, textarea, button { font-family: inherit; }
table { width:100%; border-collapse:collapse; table-layout:fixed; }
th, td { border:1px solid #ddd; padding:8px; text-align:center; word-wrap:break-word; }
th { background:#f4f4f4; }
.drug-img { width:80px; height:auto; cursor:pointer; }
.modal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; justify-content:center; align-items:center; }
.modal-content { max-width:90%; max-height:90%; }
.modal-img { max-width:100%; max-height:100%; border-radius:10px; }
#requestInput { width:100%; height:60px; resize:none; margin-bottom:6px; }
.delete-btn { background:#ff6b6b; border:none; padding:4px 8px; color:#fff; cursor:pointer; border-radius:4px; }
.delete-btn:hover { background:#e03434; }
#requestList li { display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; padding:4px 6px; border:1px solid #ccc; background:#fff; }
#requestList { list-style:none; padding:0; }

/* CSSë¡œ ëª¨ë°”ì¼ ìˆ¨ê¹€ ì²˜ë¦¬ */
@media (max-width: 768px) {
    #requestSidebar { display: none; }
}
</style>
</head>
<body>

<div id="mainContent">
    <h1>ì•½ ìœ„ì¹˜ ì°¾ê¸°</h1>
    <input type="text" id="searchBox" placeholder="ì•½ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" onkeyup="searchDrug()">
    <table id="drugTable">
        <thead>
            <tr>
                <th>ì•½í’ˆ ì‚¬ì§„</th>
                <th>ì•½í’ˆëª…</th>
                <th>ìœ„ì¹˜</th>
                <th>ìœ„ì¹˜ ì‚¬ì§„</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<div id="requestSidebar">
    <h2>ğŸ“ ìˆ˜ì • ìš”ì²­ ëª©ë¡</h2>
    <textarea id="requestInput" maxlength="200" placeholder="200ì ì´ë‚´ë¡œ ìˆ˜ì • ìš”ì²­ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
    <div style="margin-bottom:10px;">
        <button id="addSharedBtn">ì¶”ê°€</button>
    </div>
    <ul id="requestList"></ul>
</div>

<script>
const serverUrl = "http://192.168.10.77:3333/requests";
const gistUrl = "https://gist.githubusercontent.com/helian77/636699d654546e461d13702adbf34eff/raw/drug_list.txt";
let imageCache={}, currentModal=null;

async function fetchDrugData(){
    try{ const r=await fetch(gistUrl); return parseCsv(await r.text()); } catch{return [];}
}
function parseCsv(csv){
    const lines=csv.trim().split("\n"), headers=lines[0].split("\t");
    const nameIndex=headers.indexOf("name"), locIndex=headers.indexOf("location"), imgIndex=headers.indexOf("image");
    return lines.slice(1).map(l=>{
        const parts=l.split("\t");
        const locs=parts[locIndex].trim().split("/").map(s=>s.trim().replace(/-.+$/,"")).filter(s=>!s.includes("ì¹´ì„¸íŠ¸"));
        const imgs=[...new Set(locs.map(loc=>`location/thumbnail/${loc}.png`))];
        return { name:parts[nameIndex].trim(), location:parts[locIndex].trim(), imageUrl:parts[imgIndex].trim(), locationImages: imgs };
    });
}
async function displayDrugList(){
    const tbody=document.querySelector("#drugTable tbody");
    tbody.innerHTML="<tr><td colspan='4'>ë¡œë”© ì¤‘...</td></tr>";
    const drugs=await fetchDrugData();
    if(!drugs.length){ tbody.innerHTML="<tr><td colspan='4'>ë°ì´í„° ì—†ìŒ</td></tr>"; return; }
    tbody.innerHTML="";
    drugs.forEach(d=>{
        const imgs=d.locationImages.map(img=>`<img src="${img}" class="drug-img small" onerror="this.onerror=null;this.src='location/default.png'">`).join(" ");
        const row=document.createElement("tr");
        row.innerHTML=`<td><img src="${d.imageUrl}" class="drug-img" onerror="this.onerror=null;this.src='default.png'"></td>
        <td class="drug-name">${d.name}</td><td>${d.location}</td><td>${imgs}</td>`;
        tbody.appendChild(row);
    });
    document.querySelectorAll(".drug-img").forEach(img=>img.addEventListener("click",()=>showImagePopup(img.src.includes("/thumbnail/")?img.src.replace("/thumbnail/","/"):img.src)));
}
function showImagePopup(src){
    if(currentModal) currentModal.remove();
    let img=imageCache[src]||document.createElement("img");
    img.src=src; img.className="modal-img"; imageCache[src]=img;
    const modal=document.createElement("div"); modal.className="modal";
    const content=document.createElement("div"); content.className="modal-content";
    content.appendChild(img); modal.appendChild(content);
    modal.addEventListener("click",()=>modal.remove());
    document.body.appendChild(modal); currentModal=modal;
}
function searchDrug(){
    const q=document.getElementById("searchBox").value.toLowerCase();
    document.querySelectorAll("#drugTable tbody tr").forEach(r=>r.style.display=r.querySelector(".drug-name").textContent.toLowerCase().includes(q)?"":"none");
}

// ==================== ìš”ì²­ ê´€ë¦¬ ====================
function formatNow(){const d=new Date(),p=n=>String(n).padStart(2,"0"); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`;}

async function loadRequests(){
    const ul=document.getElementById("requestList");
    // ëª¨ë°”ì¼ì´ë©´ ìš”ì²­ ë¡œë“œí•˜ì§€ ì•ŠìŒ
    if(window.innerWidth <= 768){ ul.innerHTML=""; return; }

    try{
        const res=await fetch(serverUrl); const data=await res.json();
        if(!data.length){ ul.innerHTML="<li>ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</li>"; return; }
        ul.innerHTML="";
        data.forEach((item, idx)=>{
            const li=document.createElement("li");
            li.innerHTML=`<input type="checkbox" id="chk${idx}" style="margin-right:8px;">
            <label for="chk${idx}" style="flex:1;text-align:left">${item.date} | ${item.text}</label>`;
            li.style.display="flex"; li.style.alignItems="center"; ul.appendChild(li);
        });
    } catch(e){ ul.innerHTML="<li>ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</li>"; console.error(e);}
}

async function addRequest(){
    const txt=document.getElementById("requestInput").value.trim();
    if(!txt){ alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”."); return;}
    if(txt.length>200){ alert("200ì ì´í•˜ ì…ë ¥"); return; }
    const item={date:formatNow(), text:txt};
    try{
        await fetch(serverUrl, { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(item) });
        document.getElementById("requestInput").value="";
        await loadRequests();
    } catch(e){ alert("ì¶”ê°€ ì‹¤íŒ¨"); console.error(e);}
}

async function deleteChecked(){
    const ul=document.getElementById("requestList");
    const indices=[];
    ul.querySelectorAll("input[type='checkbox']").forEach((chk, idx)=>{ if(chk.checked) indices.push(idx); });
    if(!indices.length){ alert("ì‚­ì œí•  í•­ëª© ì„ íƒ"); return; }
    if(!confirm("ì²´í¬ í•­ëª© ì‚­ì œ?")) return;
    try{
        await fetch(serverUrl, { method:"DELETE", headers:{"Content-Type":"application/json"}, body:JSON.stringify(indices) });
        await loadRequests();
    } catch(e){ alert("ì‚­ì œ ì‹¤íŒ¨"); console.error(e);}
}

// ì´ë²¤íŠ¸ ì—°ê²°
document.getElementById("addSharedBtn").onclick = addRequest;
const delBtn=document.createElement("button"); delBtn.textContent="ì²´í¬ í•­ëª© ì‚­ì œ"; delBtn.style.marginTop="6px"; delBtn.onclick=deleteChecked;
document.getElementById("requestSidebar").appendChild(delBtn);

window.onload=displayDrugList;
document.addEventListener("DOMContentLoaded", loadRequests);
</script>
</body>
</html>
